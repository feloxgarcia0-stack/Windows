name: RDP con Serveo.net (Sin Descargas)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Habilitar RDP y Crear Usuario
        run: |
          $Password = "P@ssw0rdFeloxPC2025!"
          net user Runner $Password /add /y
          net localgroup administrators Runner /add
          net localgroup "Remote Desktop Users" Runner /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="Allow RDP" dir=in action=allow protocol=TCP localport=3389
          echo "RDP_USER=Runner" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "RDP_PASSWORD=$Password" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Iniciar Túnel con Serveo.net
        run: |
          # Inicia el túnel SSH en segundo plano. No se descarga nada.
          # -o StrictHostKeyChecking=no : Acepta la clave del servidor automáticamente.
          # -R 0:localhost:3389 : Pide a Serveo un puerto aleatorio para nuestro puerto RDP (3389).
          Start-Process -FilePath "ssh" -ArgumentList "-o StrictHostKeyChecking=no -R 0:localhost:3389 serveo.net" -NoNewWindow -RedirectStandardError "$env:TEMP\serveo.log" -RedirectStandardOutput "$env:TEMP\serveo_out.log"
          
          # Espera a que se establezca la conexión y se genere la dirección.
          Write-Host "Esperando a que Serveo.net establezca la conexión (20 segundos)..."
          Start-Sleep -Seconds 20
          
          # Busca la dirección pública en el log. El texto de Serveo es muy predecible.
          $ServeoAddress = Get-Content "$env:TEMP\serveo.log" | Select-String -Pattern "Forwarding TCP from (.*) to" | ForEach-Object { $_.Matches[1].Groups[1].Value } | Select-Object -Last 1
          
          # Si no se encuentra, muestra un error.
          if (-not $ServeoAddress) {
              Write-Error "Error: No se pudo obtener la dirección del túnel de Serveo.net."
              Write-Host "Contenido del log:"
              Get-Content "$env:TEMP\serveo.log"
              exit 1
          }
          
          echo "SERVEO_ADDRESS=$ServeoAddress" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Mostrar Credenciales de Conexión
        run: |
          Write-Host "================================================================"
          Write-Host "               CREDENCIALES DE ACCESO RDP"
          Write-Host "================================================================"
          Write-Host ""
          Write-Host "   Usa los siguientes datos en tu cliente de Escritorio Remoto:"
          Write-Host ""
          Write-Host "   Dirección (PC Name): ${{ env.SERVEO_ADDRESS }}"
          Write-Host "   Usuario:             ${{ env.RDP_USER }}"
          Write-Host "   Contraseña:          ${{ env.RDP_PASSWORD }}"
          Write-Host ""
          Write-Host "   NOTA: La dirección incluye el puerto. Cópiala y pégala tal cual."
          Write-Host "   (Ejemplo: random.serveo.net:12345)"
          Write-Host "================================================================"
          
      - name: Mantener la Conexión Activa
        run: Start-Sleep -Seconds 21300
